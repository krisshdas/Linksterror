<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ad Page | Linksterror</title>

  <link rel="stylesheet" href="ads.css" />
</head>
<body>
  <div id="ad-container">
    <h2>Sponsored Ads</h2>

    <div id="header-ad"></div>

    <div id="side-ads">
      <div id="side1"></div>
      <div id="side2"></div>
      <div id="side3"></div>
      <div id="side4"></div>
    </div>

    <div id="bottom-ad"></div>
  </div>

  <p id="redirect-timer">Please wait, redirecting soon...</p>

  <!-- ✅ Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- ✅ Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBMSFIlfrXV9vPdpXUJm3HkaFVJwXeB0h8",
      authDomain: "link-shortner-2898c.firebaseapp.com",
      databaseURL: "https://link-shortner-2898c-default-rtdb.firebaseio.com",
      projectId: "link-shortner-2898c",
      storageBucket: "link-shortner-2898c.firebasestorage.app",
      messagingSenderId: "283153832071",
      appId: "1:283153832071:web:8704bb833305447d4f8022",
      measurementId: "G-J3XWHEX759"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- ✅ NEW: Extract UID & Target from URL (fallback) -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const uid = params.get("uid");
    const target = params.get("target");

    if (uid) sessionStorage.setItem("userId", uid);
    if (target) sessionStorage.setItem("originalUrl", target);
  </script>

  <!-- ✅ Override ad-page.js Firebase path -->
  <script>
    const userId = sessionStorage.getItem("userId");

    if (userId) {
      const originalRef = firebase.database.Reference.prototype.child;

      firebase.database.Reference.prototype.child = function (path) {
        // If code requests "ads/config/ad1", rewrite to user path
        if (path.startsWith("ads/config")) {
          const adPage = path.split("/").pop();
          console.log("Loading ads for user:", userId, "ad page:", adPage);
          return firebase.database().ref(`users/${userId}/ads/${adPage}`);
        }
        return originalRef.call(this, path);
      };
    } else {
      console.warn("⚠️ No userId found in sessionStorage — ads may not load.");
    }
  </script>

  <!-- ✅ Load main ad logic -->
  <script src="ad-page.js"></script>

  <!-- ✅ Redirect Timer -->
  <script>
    const targetUrl = sessionStorage.getItem("originalUrl");
    const timerEl = document.getElementById("redirect-timer");

    if (targetUrl) {
      let seconds = 7;
      timerEl.textContent = `Redirecting in ${seconds}s...`;

      const countdown = setInterval(() => {
        seconds--;
        timerEl.textContent = `Redirecting in ${seconds}s...`;

        if (seconds <= 0) {
          clearInterval(countdown);
          window.location.href = targetUrl;
        }
      }, 1000);
    } else {
      timerEl.textContent = "⚠️ No redirect target found.";
    }
  </script>
</body>
</html>
