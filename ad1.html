<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ad Page</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { background: #111; color: white; text-align: center; font-family: sans-serif; }
    #headerAd { margin: 20px auto; background: #1e1e1e; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>üî• Your Ad Page</h2>
  <div id="headerAd"></div>

  <script>
    // Firebase config (your same one)
    const firebaseConfig = {
      apiKey: "AIzaSyBMSFIlfrXV9vPdpXUJm3HkaFVJwXeB0h8",
      authDomain: "link-shortner-2898c.firebaseapp.com",
      databaseURL: "https://link-shortner-2898c-default-rtdb.firebaseio.com",
      projectId: "link-shortner-2898c",
      storageBucket: "link-shortner-2898c.firebasestorage.app",
      messagingSenderId: "283153832071",
      appId: "1:283153832071:web:8704bb833305447d4f8022",
      measurementId: "G-J3XWHEX759"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // üîç Helper: execute ad scripts correctly
    function executeAdScript(containerId, code) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = code;

      // run <script> elements
      tempDiv.querySelectorAll('script').forEach(script => {
        const newScript = document.createElement('script');
        if (script.src) newScript.src = script.src;
        else newScript.textContent = script.textContent;
        document.body.appendChild(newScript);
      });

      // append non-script nodes (html markup)
      Array.from(tempDiv.childNodes).forEach(node => {
        if (node.tagName !== 'SCRIPT') container.appendChild(node);
      });
    }

    // üß≠ Get shortCode from ?link= parameter
    const urlParams = new URLSearchParams(window.location.search);
    const shortCode = urlParams.get("link");

    // üîé Fetch matching link from Firebase
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val();
      for (const uid in users) {
        const links = users[uid].links || {};
        for (const linkId in links) {
          const link = links[linkId];
          if (link.shortCode === shortCode) {
            // ‚úÖ Run ads
            if (link.ads?.ad1?.header) {
              executeAdScript("headerAd", link.ads.ad1.header);
            }

            // üïí Redirect after 10 sec
            setTimeout(() => {
              window.location.href = link.longUrl;
            }, 10000);

            return;
          }
        }
      }
      document.body.innerHTML = "<h3>‚ùå Link not found!</h3>";
    });
  </script>
</body>
</html>
