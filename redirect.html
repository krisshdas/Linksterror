<!-- redirect.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Redirecting...</title>
  <style>
    body { font-family: sans-serif; text-align:center; padding-top:40px; }
    #ad-frame { width:90%; height:300px; border:none; margin:auto; display:block; }
  </style>
</head>
<body>
  <h2>Your content will load shortly...</h2>
  <iframe id="ad-frame"></iframe>
  <p id="timer"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMSFIlfrXV9vPdpXUJm3HkaFVJwXeB0h8",
      authDomain: "link-shortner-2898c.firebaseapp.com",
      databaseURL: "https://link-shortner-2898c-default-rtdb.firebaseio.com",
      projectId: "link-shortner-2898c",
      storageBucket: "link-shortner-2898c.firebasestorage.app",
      messagingSenderId: "283153832071",
      appId: "1:283153832071:web:8704bb833305447d4f8022",
      measurementId: "G-J3XWHEX759"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const id = new URLSearchParams(location.search).get("id");
    const adFrame = document.getElementById("ad-frame");
    const timer = document.getElementById("timer");

    async function loadLink() {
      if (!id) return (timer.textContent = "No ID provided");

      const snap = await get(ref(db, `links/${id}`));
      if (!snap.exists()) return (timer.textContent = "Link not found");

      const data = snap.val();
      const adCode = data.adConfig?.snippet || "";

      // Load ad snippet safely in sandboxed iframe
      const doc = adFrame.contentDocument;
      doc.open();
      doc.write(adCode || "<p>No ad configured</p>");
      doc.close();

      // countdown + redirect
      let sec = 7;
      const interval = setInterval(() => {
        timer.textContent = `Redirecting in ${sec}s...`;
        sec--;
        if (sec < 0) {
          clearInterval(interval);
          location.href = data.target;
        }
      }, 1000);
    }

    loadLink();
  </script>
</body>
</html>
